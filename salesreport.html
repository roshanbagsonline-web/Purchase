<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Analytics Pro | Roshan Online</title>
    <link rel="icon" href="https://img.icons8.com/fluency/48/graph-report.png" type="image/png">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Plus+Jakarta+Sans:wght@700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        :root {
            --brand: #6366f1;
            --brand-soft: #eef2ff;
            --surface: #ffffff;
            --bg: #f8fafc;
            --text-main: #0f172a;
            --text-sub: #64748b;
            --success-bg: #dcfce7;
            --success-text: #166534;
            --warning-bg: #fef3c7;
            --warning-text: #92400e;
            --shadow: 0 20px 25px -5px rgb(0 0 0 / 0.05), 0 8px 10px -6px rgb(0 0 0 / 0.05);
        }

        body { 
            background-color: var(--bg); 
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            padding: 2rem 1rem;
            -webkit-font-smoothing: antialiased;
        }

        .dashboard-container {
            max-width: 850px;
            margin: auto;
            animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .glass-header {
            background: var(--surface);
            border-radius: 24px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255,255,255,0.7);
        }

        h4 { font-family: 'Plus Jakarta Sans', sans-serif; font-weight: 800; letter-spacing: -0.5px; }

        .control-grid {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 12px;
            margin-top: 1.5rem;
        }

        .form-select, .form-control {
            border: 1px solid #e2e8f0;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .form-select:focus { border-color: var(--brand); box-shadow: 0 0 0 4px var(--brand-soft); }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: var(--surface);
            padding: 1.5rem;
            border-radius: 20px;
            box-shadow: var(--shadow);
            transition: transform 0.2s;
        }

        .stat-label { font-size: 0.7rem; font-weight: 800; color: var(--text-sub); text-transform: uppercase; letter-spacing: 1.2px; }
        .stat-value { font-size: 2rem; font-weight: 800; font-family: 'Plus Jakarta Sans'; color: var(--brand); margin: 0.2rem 0; }
        
        #bagsTotal, #luggageTotal { font-size: 1.4rem; letter-spacing: -0.5px; }

        .revenue-section {
            background: #0f172a;
            color: white;
            border-radius: 24px;
            padding: 2.5rem;
            text-align: center;
            box-shadow: 0 25px 50px -12px rgba(99, 102, 241, 0.35);
            margin-bottom: 2rem;
        }

        .table-wrapper {
            background: var(--surface);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .table-custom { width: 100%; border-collapse: collapse; }
        .table-custom th { background: #f8fafc; padding: 1rem; font-size: 0.7rem; color: var(--text-sub); text-transform: uppercase; border-bottom: 1px solid #e2e8f0; }
        .table-custom td { padding: 1rem; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }

        .table-amount-cell { font-size: 1.15rem !important; }

        .day-summary-row { background: #fcfcfc !important; }
        .subtotal-pill {
            display: inline-flex;
            align-items: center;
            padding: 6px 14px;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 800;
            margin-left: 8px;
        }
        .pill-bags { background: var(--brand-soft); color: var(--brand); }
        .pill-lugg { background: var(--warning-bg); color: var(--warning-text); }
        .pill-total { background: var(--text-main); color: #fff; border-radius: 8px; }

        .product-details-rows table tr td {
            border-bottom: 1px solid #f8fafc;
        }

        @media (max-width: 600px) {
            .control-grid { grid-template-columns: 1fr; }
            .revenue-section { padding: 1.5rem; }
            .subtotal-pill { margin-top: 8px; width: 100%; justify-content: space-between; margin-left: 0; }
        }

        #loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 3px;
            background: var(--brand-soft); z-index: 9999; display: none;
        }
        #loader-bar { height: 100%; background: var(--brand); width: 0%; transition: width 0.4s ease; }
    </style>
</head>
<body>

<div id="loader-overlay"><div id="loader-bar"></div></div>

<div class="dashboard-container">
    <div class="glass-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <span class="badge" style="background: var(--success-bg); color: var(--success-text); font-weight: 700;">LIVE REPORT</span>
                <h4 class="mt-2 mb-0" id="rangeLabel">Loading Analytics...</h4>
            </div>
            <div id="status" class="small fw-bold text-muted">SYNCING...</div>
        </div>

        <div class="control-grid">
            <select id="datePreset" class="form-select" onchange="handlePresetChange()">
                <option value="today">Today</option>
                <option value="yesterday">Yesterday</option>
                <option value="last7" selected>Last 7 Days</option>
                <option value="thisMonth">This Month</option>
                <option value="custom">Custom Range</option>
            </select>
            <div id="customInputs" class="d-none gap-2">
                <input type="date" id="startDate" class="form-control" onchange="processReport()">
                <input type="date" id="endDate" class="form-control" onchange="processReport()">
            </div>
        </div>
    </div>

    <div class="stat-grid">
        <div class="stat-card">
            <div class="stat-label">Bags</div>
            <div class="stat-value" id="bagsQty">0</div>
            <div class="fw-bold" id="bagsTotal" style="color: var(--brand)">₹0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Luggages</div>
            <div class="stat-value" id="luggageQty">0</div>
            <div class="fw-bold" id="luggageTotal" style="color: var(--warning-text)">₹0</div>
        </div>
    </div>

    <div class="revenue-section">
        <div class="small text-uppercase opacity-50 fw-bold letter-spacing-1">Total Period Revenue</div>
        <div class="display-3 fw-bold my-2" id="grandTotal" style="font-family: 'Plus Jakarta Sans'">₹0</div>
        <div class="small opacity-75" id="totalInWords">Zero Rupees</div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3 px-2">
        <h6 class="fw-bold mb-0">ITEMISED DAILY LOGS</h6>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="showDetails" onchange="toggleDetails()">
            <label class="form-check-label small fw-bold text-muted" for="showDetails">Show List</label>
        </div>
    </div>

    <div id="detailsSection" class="table-wrapper">
        <table class="table-custom" id="mainTable">
            <thead>
                <tr>
                    <th style="width: 25%">Date</th>
                    <th style="width: 50%">Product Summary</th>
                    <th style="width: 25%" class="text-end">Daily Total</th>
                </tr>
            </thead>
            <tbody id="productTableBody"></tbody>
        </table>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzEvkFDj2zXw2KMc3GA5iQv0E9yZ4ISmG2xxx3RuYMMREHbot-lXcd9mUblj9GVG1uK/exec?action=getOrders";
    let allOrders = [];

    async function initialLoad() {
        setLoader(true);
        try {
            const res = await fetch(API_URL);
            const data = await res.json();
            allOrders = data.orders;
            document.getElementById('status').innerText = "ONLINE";
            handlePresetChange();
        } catch (e) {
            document.getElementById('status').innerText = "OFFLINE";
        } finally {
            setLoader(false);
        }
    }

    function setLoader(active) {
        const bar = document.getElementById('loader-bar');
        document.getElementById('loader-overlay').style.display = active ? "block" : "none";
        if(active) { bar.style.width = "30%"; setTimeout(() => bar.style.width = "80%", 300); }
    }

    function handlePresetChange() {
        const preset = document.getElementById('datePreset').value;
        const customDiv = document.getElementById('customInputs');
        customDiv.classList.toggle('d-flex', preset === 'custom');
        customDiv.classList.toggle('d-none', preset !== 'custom');
        processReport();
    }

    function processReport() {
        const preset = document.getElementById('datePreset').value;
        let start = new Date(), end = new Date();
        start.setHours(0,0,0,0); end.setHours(23,59,59,999);

        if (preset === 'yesterday') { start.setDate(start.getDate()-1); end = new Date(start); end.setHours(23,59,59); }
        else if (preset === 'last7') { start.setDate(start.getDate()-7); }
        else if (preset === 'thisMonth') { start = new Date(start.getFullYear(), start.getMonth(), 1); }
        else if (preset === 'custom') {
            const s = document.getElementById('startDate').value;
            const e = document.getElementById('endDate').value;
            if (!s || !e) return;
            start = new Date(s); end = new Date(e);
        }

        // UPDATED: Now shows day, month name, and full year
        const dateOptions = { day: '2-digit', month: 'short', year: 'numeric' };
        document.getElementById('rangeLabel').innerText = `${start.toLocaleDateString('en-GB', dateOptions)} - ${end.toLocaleDateString('en-GB', dateOptions)}`;

        const filtered = allOrders.filter(o => {
            const d = new Date(o.orderDate);
            return d >= start && d <= end;
        }).sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate));

        renderData(filtered);
    }

    function renderData(orders) {
        let globalBagsAmt = 0, globalBagsQty = 0, globalLuggAmt = 0, globalLuggQty = 0;
        let tableHTML = "";
        let dayBags = 0, dayLugg = 0, lastDate = null;
        let dayProductsHTML = ""; 

        const createDayBlock = (date, b, l, products) => `
            <tr class="day-summary-row border-bottom">
                <td colspan="3" class="text-end py-3 px-3">
                    <span class="float-start small fw-bold text-muted mt-2">${date}</span>
                    <span class="subtotal-pill pill-bags">Bags: ₹${b.toLocaleString('en-IN')}</span>
                    <span class="subtotal-pill pill-lugg">Lugg: ₹${l.toLocaleString('en-IN')}</span>
                    <span class="subtotal-pill pill-total">TOTAL: ₹${(b+l).toLocaleString('en-IN')}</span>
                </td>
            </tr>
            <tr class="product-details-rows" style="display: ${document.getElementById('showDetails').checked ? 'table-row' : 'none'}">
                <td colspan="3" class="p-0 border-bottom">
                    <table class="w-100 mb-0">
                        ${products}
                    </table>
                </td>
            </tr>`;

        orders.forEach((order, index) => {
            const price = parseFloat(order.price || 0);
            const isBag = String(order.productCategory).toLowerCase().includes("bag");
            const dateStr = new Date(order.orderDate).toLocaleDateString('en-GB', {day:'2-digit', month:'short'});

            if (lastDate && lastDate !== dateStr) {
                tableHTML += createDayBlock(lastDate, dayBags, dayLugg, dayProductsHTML);
                dayBags = 0; dayLugg = 0; dayProductsHTML = "";
            }

            if (isBag) { globalBagsAmt += price; globalBagsQty++; dayBags += price; }
            else { globalLuggAmt += price; globalLuggQty++; dayLugg += price; }

            dayProductsHTML += `
                <tr style="background: #fff">
                    <td style="width: 25%" class="ps-3 small text-muted py-2">${dateStr}</td>
                    <td style="width: 50%" class="py-2"><div class="fw-semibold small">${order.productName}</div></td>
                    <td style="width: 25%" class="text-end pe-3 fw-bold table-amount-cell py-2">₹${price.toLocaleString('en-IN')}</td>
                </tr>`;
            
            lastDate = dateStr;
            if (index === orders.length - 1) tableHTML += createDayBlock(lastDate, dayBags, dayLugg, dayProductsHTML);
        });

        requestAnimationFrame(() => {
            document.getElementById('bagsQty').innerText = globalBagsQty;
            document.getElementById('bagsTotal').innerText = "₹" + globalBagsAmt.toLocaleString('en-IN');
            document.getElementById('luggageQty').innerText = globalLuggQty;
            document.getElementById('luggageTotal').innerText = "₹" + globalLuggAmt.toLocaleString('en-IN');
            
            const total = globalBagsAmt + globalLuggAmt;
            document.getElementById('grandTotal').innerText = "₹" + total.toLocaleString('en-IN');
            document.getElementById('totalInWords').innerText = numberToWords(total) + " Only";
            document.getElementById('productTableBody').innerHTML = tableHTML || '<tr><td colspan="3" class="text-center py-5">No Sales Found</td></tr>';
        });
    }

    function toggleDetails() {
        const isVisible = document.getElementById('showDetails').checked;
        const detailRows = document.querySelectorAll('.product-details-rows');
        detailRows.forEach(row => {
            row.style.display = isVisible ? "table-row" : "none";
        });
    }

    function numberToWords(num) {
        if (num === 0) return "Zero Rupees";
        const a = ['','One ','Two ','Three ','Four ','Five ','Six ','Seven ','Eight ','Nine ','Ten ','Eleven ','Twelve ','Thirteen ','Fourteen ','Fifteen ','Sixteen ','Seventeen ','Eighteen ','Nineteen '];
        const b = ['', '', 'Twenty','Thirty','Forty','Fifty','Sixty','Seventy','Eighty','Ninety'];
        const make = (n) => {
            if (n < 20) return a[n];
            if (n < 100) return b[Math.floor(n/10)] + (n%10 !== 0 ? " " + a[n%10] : "");
            if (n < 1000) return a[Math.floor(n/100)] + "Hundred " + (n%100 !== 0 ? "and " + make(n%100) : "");
            if (n < 100000) return make(Math.floor(n/1000)) + "Thousand " + (n%1000 !== 0 ? make(n%1000) : "");
            if (n < 10000000) return make(Math.floor(n/100000)) + "Lakh " + (n%100000 !== 0 ? make(n%100000) : "");
            return n.toLocaleString();
        };
        return make(Math.floor(num)) + "Rupees";
    }

    window.onload = initialLoad;
</script>
</body>
</html>
